<div class="page-header">
  <h1 class="page-title">Precios</h1>
  @if (hasSelection()) {
    <button mat-fab extended (click)="reset()" class="reset-button">
      <mat-icon>refresh</mat-icon>
      <span class="button-text">Nuevo</span>
    </button>
  }
</div>

<div class="container">
  <!-- Configuration Card -->
  <mat-card class="config-card">
    <mat-card-header>
      <mat-card-title>Configuraci√≥n</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="config-grid">
        <mat-form-field appearance="outline">
          <mat-label>Masa</mat-label>
          <mat-select [value]="selectedDoughId()" 
                      (selectionChange)="selectedDoughId.set($event.value)">
            @for (dough of doughs(); track dough.id) {
              <mat-option [value]="dough.id">{{ dough.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Receta</mat-label>
          <mat-select [value]="selectedRecipeId()" 
                      (selectionChange)="selectedRecipeId.set($event.value)">
            @for (recipe of recipes(); track recipe.id) {
              <mat-option [value]="recipe.id">{{ recipe.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Peso por bollo (g)</mat-label>
          <input matInput type="number" 
                 [ngModel]="doughBallWeight()" 
                 (ngModelChange)="doughBallWeight.set($event)"
                 min="1">
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  @if (hasSelection()) {
    <!-- Dough Ingredients Card -->
    <mat-card class="detail-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon class="title-icon">bakery_dining</mat-icon>
          Costos de Masa: {{ selectedDough()?.name }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Mobile View -->
        <div class="mobile-view">
          @for (ingredient of doughIngredients(); track $index) {
            <div class="ingredient-row-mobile">
              <div class="ingredient-name">{{ ingredient.name }}</div>
              <div class="ingredient-details">
                <span class="detail-item">{{ ingredient.quantity }}g</span>
                <span class="detail-item">${{ ingredient.unitCost.toFixed(2) }}/kg</span>
                <span class="detail-item total">${{ ingredient.totalCost.toFixed(2) }}</span>
              </div>
              <div class="margin-field">
                <mat-form-field appearance="outline">
                  <mat-label>Margen %</mat-label>
                  <input matInput type="number" 
                         [value]="ingredient.margin" 
                         (blur)="updateIngredientMargin(ingredient.costId, $any($event.target).value)"
                         min="0">
                </mat-form-field>
              </div>
            </div>
          }
          <div class="subtotal-row">
            <span>Subtotal Masa:</span>
            <span class="subtotal-value">${{ doughCost().toFixed(2) }}</span>
          </div>
        </div>

        <!-- Desktop View -->
        <div class="desktop-view">
          <table mat-table [dataSource]="doughIngredients()" class="mat-elevation-z2">
            <ng-container matColumnDef="ingredient">
              <th mat-header-cell *matHeaderCellDef>Ingrediente</th>
              <td mat-cell *matCellDef="let ing">{{ ing.name }}</td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let ing">{{ ing.quantity }}g</td>
            </ng-container>

            <ng-container matColumnDef="unitCost">
              <th mat-header-cell *matHeaderCellDef>Costo/kg</th>
              <td mat-cell *matCellDef="let ing">${{ ing.unitCost.toFixed(2) }}</td>
            </ng-container>

            <ng-container matColumnDef="totalCost">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let ing" class="cost-cell">
                ${{ ing.totalCost.toFixed(2) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="margin">
              <th mat-header-cell *matHeaderCellDef>Margen %</th>
              <td mat-cell *matCellDef="let ing">
                <input matInput type="number" 
                       [value]="ing.margin" 
                       (blur)="updateIngredientMargin(ing.costId, $any($event.target).value)"
                       min="0"
                       class="margin-input">
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          <div class="subtotal-section">
            <span class="subtotal-label">Subtotal Masa:</span>
            <span class="subtotal-value">${{ doughCost().toFixed(2) }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Recipe Ingredients Card -->
    <mat-card class="detail-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon class="title-icon">restaurant</mat-icon>
          Costos de Receta: {{ selectedRecipe()?.name }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Mobile View -->
        <div class="mobile-view">
          @for (ingredient of recipeIngredients(); track $index) {
            <div class="ingredient-row-mobile">
              <div class="ingredient-name">{{ ingredient.name }}</div>
              <div class="ingredient-details">
                <span class="detail-item">{{ ingredient.quantity }}g</span>
                <span class="detail-item">${{ ingredient.unitCost.toFixed(2) }}/kg</span>
                <span class="detail-item total">${{ ingredient.totalCost.toFixed(2) }}</span>
              </div>
              <div class="margin-field">
                <mat-form-field appearance="outline">
                  <mat-label>Margen %</mat-label>
                  <input matInput type="number" 
                         [value]="ingredient.margin" 
                         (blur)="updateIngredientMargin(ingredient.costId, $any($event.target).value)"
                         min="0">
                </mat-form-field>
              </div>
            </div>
          }
          <div class="subtotal-row">
            <span>Subtotal Receta:</span>
            <span class="subtotal-value">${{ recipeCost().toFixed(2) }}</span>
          </div>
        </div>

        <!-- Desktop View -->
        <div class="desktop-view">
          <table mat-table [dataSource]="recipeIngredients()" class="mat-elevation-z2">
            <ng-container matColumnDef="ingredient">
              <th mat-header-cell *matHeaderCellDef>Ingrediente</th>
              <td mat-cell *matCellDef="let ing">{{ ing.name }}</td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let ing">{{ ing.quantity }}g</td>
            </ng-container>

            <ng-container matColumnDef="unitCost">
              <th mat-header-cell *matHeaderCellDef>Costo/kg</th>
              <td mat-cell *matCellDef="let ing">${{ ing.unitCost.toFixed(2) }}</td>
            </ng-container>

            <ng-container matColumnDef="totalCost">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let ing" class="cost-cell">
                ${{ ing.totalCost.toFixed(2) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="margin">
              <th mat-header-cell *matHeaderCellDef>Margen %</th>
              <td mat-cell *matCellDef="let ing">
                <input matInput type="number" 
                       [value]="ing.margin" 
                       (blur)="updateIngredientMargin(ing.costId, $any($event.target).value)"
                       min="0"
                       class="margin-input">
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          <div class="subtotal-section">
            <span class="subtotal-label">Subtotal Receta:</span>
            <span class="subtotal-value">${{ recipeCost().toFixed(2) }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Summary Card -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon class="title-icon">calculate</mat-icon>
          Resumen de Precios
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-section">
          <h3 class="section-title">Por Pizza</h3>
          <div class="summary-row">
            <span class="label">Costo de Masa:</span>
            <span class="value">${{ doughCost().toFixed(2) }}</span>
          </div>
          <div class="summary-row">
            <span class="label">Costo de Receta:</span>
            <span class="value">${{ recipeCost().toFixed(2) }}</span>
          </div>
          <mat-divider></mat-divider>
          <div class="summary-row highlight">
            <span class="label">Costo Total por Pizza:</span>
            <span class="value">${{ baseCost().toFixed(2) }}</span>
          </div>
          
          <div class="summary-row">
            <span class="label">Margen de Ganancia ({{ totalMarginPercentage().toFixed(2) }}%):</span>
            <span class="value">${{ marginAmount().toFixed(2) }}</span>
          </div>

          <div class="summary-row">
            <span class="label">Redondeo Comercial:</span>
            <span class="value">${{ commercialRounding().toFixed(2) }}</span>
          </div>

          <mat-divider></mat-divider>
          <div class="summary-row price">
            <span class="label">Precio de Venta por Pizza:</span>
            <span class="value">${{ pricePerUnit().toFixed(2) }}</span>
          </div>
        </div>

        @if (quantity() > 1) {
          <mat-divider class="section-divider"></mat-divider>
          <div class="summary-section">
            <h3 class="section-title">Total para {{ quantity() }} Pizzas</h3>
            <div class="summary-row">
              <span class="label">Costo Total:</span>
              <span class="value">${{ totalCost().toFixed(2) }}</span>
            </div>
            <div class="summary-row">
              <span class="label">Margen Total:</span>
              <span class="value">${{ totalMargin().toFixed(2) }}</span>
            </div>
            <div class="summary-row total">
              <span class="label">Precio Total de Venta:</span>
              <span class="value">${{ totalPrice().toFixed(2) }}</span>
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
